<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Clemens' blog - Custom progress bars for RcppProgress</title>
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="stylesheet" href="../css/syntax.css" />
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="https://orcid.org/0000-0003-3448-5715" aria-label="View ORCID record">
                    <img src="../images/ORCID-iD_icon_BW_16x16.png" alt="ORCID iD" />
                    0000-0003-3448-5715 ← Clemens
                </a>
            </div>
            
            <nav>
                <a href="../">Other blog posts</a>
                <a href="https://github.com/nevrome/nevrome.de">GitHub</a>
                <!--
                <a href="/about.html">About</a>
                <a href="/contact.html">Contact</a>
                <a href="/archive.html">Archive</a>
                -->
            </nav>
        </header>

        <main role="main">
            <h1>Custom progress bars for RcppProgress</h1>
            <article>
    <section class="header">
        Posted
        
            originally <a href="https://gallery.rcpp.org/articles/custom-bars-rcppprogress">here</a>
        
        on December 28, 2017
        
            by Clemens Schmid and Karl Forner
        
    </section>
    <section>
        <p><a href="http://cran.r-project.org/web/packages/RcppProgress/index.html">RcppProgress</a>
is a tool to help you monitor the execution time of your C++ code, by
providing a way to interrupt the execution inside the C++ code, and also to
display a progress bar indicative of the state of your computation. Additionally,
it is compatible with multi-threaded code, for example using OpenMP.
<a href="https://gallery.rcpp.org/articles/using-rcppprogress/">The initial (yet updated) article</a> explains the
basic setup.</p>
<p>Since version 0.4 it became more simple to create custom progress bars. In this new
article we will show how to do this. Our final example displays a progress bar which
provides an estimation of the remaining time (ETA) to finish a computation.</p>
<h3 id="a-minimal-example">A minimal example</h3>
<p>Imagine you added a progress bar with RcppProgress to your function
<code>long_computation()</code> following the example from the first article mentioned above.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">// [[Rcpp::depends(RcppProgress)]]</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="pp">#include </span><span class="im">&lt;progress.hpp&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="pp">#include </span><span class="im">&lt;progress_bar.hpp&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="dt">double</span> long_computation<span class="op">(</span><span class="dt">int</span> nb<span class="op">,</span> <span class="dt">bool</span> display_progress<span class="op">=</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="dt">double</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    Progress p<span class="op">(</span>nb<span class="op">*</span>nb<span class="op">,</span> display_progress<span class="op">);</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nb<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>        <span class="cf">if</span> <span class="op">(</span>Progress<span class="op">::</span>check_abort<span class="op">()</span> <span class="op">)</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>            <span class="cf">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> nb<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>            p<span class="op">.</span>increment<span class="op">();</span> </span>
<span id="cb1-13"><a href="#cb1-13"></a>            sum <span class="op">+=</span> R<span class="op">::</span>dlnorm<span class="op">(</span>i<span class="op">+</span>j<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>        <span class="op">}</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>    <span class="op">}</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>    <span class="cf">return</span> sum <span class="op">+</span> nb<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="op">}</span></span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a>long_computation<span class="op">(</span><span class="dv">10</span><span class="op">)</span></span></code></pre></div>
<p>What you get is a basic and useful console visualization that looks like this:</p>
<pre><code>0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----|
******************************</code></pre>
<p>That’s the default, platform independent display in RcppProgress defined in
<a href="https://github.com/kforner/rcpp_progress/blob/master/inst/include/simple_progress_bar.hpp">SimpleProgressBar.hpp</a>.
It’s OK for most purposes to give you an idea how much work is done and it also allows
you to make a very intuitive estimation about how long it’s going to take to finish.
But of course that’s not everything a progress bar <em>could</em> show you. A progress bar
could give you information about the running progress or about performance parameters
of your system. It could contain calculated estimates of passed and remaining time.
After all it could just look much more fancy to impress your colleagues.</p>
<p>RcppProgress makes it now easy to create your own implementation of a progress bar class.
Your own class has to be derived from the abstract class <code>ProgressBar</code> that defines some
basic virtual methods:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">class</span> ProgressBar <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="kw">public</span><span class="op">:</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="kw">virtual</span> <span class="op">~</span>ProgressBar<span class="op">()</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="kw">virtual</span> <span class="dt">void</span> display<span class="op">()</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="kw">virtual</span> <span class="dt">void</span> update<span class="op">(</span><span class="dt">float</span> progress<span class="op">)</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="kw">virtual</span> <span class="dt">void</span> end_display<span class="op">()</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="op">};</span></span></code></pre></div>
<p><code>display()</code> starts the display that will be updated by subsequent calls of
<code>update()</code>. <code>end_display</code> finalizes it. Your progress bar implementation should
not rely on the destructor to finalize the display.</p>
<p>A very <strong>minimal setup</strong> could look something like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Print.h&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">// [[Rcpp::depends(RcppProgress)]]</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="pp">#include </span><span class="im">&lt;progress.hpp&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="pp">#include </span><span class="im">&quot;progress_bar.hpp&quot;</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="kw">class</span> MinimalProgressBar<span class="op">:</span> <span class="kw">public</span> ProgressBar<span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="kw">public</span><span class="op">:</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>    MinimalProgressBar<span class="op">()</span>  <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>        _finalized <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="op">}</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    </span>
<span id="cb4-13"><a href="#cb4-13"></a>    <span class="op">~</span>MinimalProgressBar<span class="op">()</span> <span class="op">{}</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>    </span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="dt">void</span> display<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>      REprintf<span class="op">(</span><span class="st">&quot;Progress: &quot;</span><span class="op">);</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>    <span class="op">}</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>    </span>
<span id="cb4-19"><a href="#cb4-19"></a>    <span class="dt">void</span> update<span class="op">(</span><span class="dt">float</span> progress<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>      <span class="cf">if</span> <span class="op">(</span>_finalized<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>      REprintf<span class="op">(</span><span class="st">&quot;+&quot;</span><span class="op">);</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>    <span class="op">}</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>    </span>
<span id="cb4-24"><a href="#cb4-24"></a>    <span class="dt">void</span> end_display<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>      <span class="cf">if</span> <span class="op">(</span>_finalized<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>      REprintf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>      _finalized <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>    <span class="op">}</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>    </span>
<span id="cb4-30"><a href="#cb4-30"></a>  <span class="kw">private</span><span class="op">:</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>  </span>
<span id="cb4-32"><a href="#cb4-32"></a>    <span class="dt">bool</span> _finalized<span class="op">;</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>          </span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="op">};</span></span>
<span id="cb4-35"><a href="#cb4-35"></a></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="dt">double</span> long_computation_minimal<span class="op">(</span><span class="dt">int</span> nb<span class="op">,</span> <span class="dt">bool</span> display_progress<span class="op">=</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-38"><a href="#cb4-38"></a>    MinimalProgressBar pb<span class="op">;</span></span>
<span id="cb4-39"><a href="#cb4-39"></a>    <span class="dt">double</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-40"><a href="#cb4-40"></a>    Progress p<span class="op">(</span>nb<span class="op">,</span> display_progress<span class="op">,</span> pb<span class="op">);</span></span>
<span id="cb4-41"><a href="#cb4-41"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> nb<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-42"><a href="#cb4-42"></a>        <span class="cf">if</span> <span class="op">(</span>Progress<span class="op">::</span>check_abort<span class="op">()</span> <span class="op">)</span></span>
<span id="cb4-43"><a href="#cb4-43"></a>            <span class="cf">return</span> <span class="op">-</span><span class="fl">1.0</span><span class="op">;</span></span>
<span id="cb4-44"><a href="#cb4-44"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> nb<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-45"><a href="#cb4-45"></a>            sum <span class="op">+=</span> R<span class="op">::</span>dlnorm<span class="op">(</span>i<span class="op">+</span>j<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb4-46"><a href="#cb4-46"></a>        <span class="op">}</span></span>
<span id="cb4-47"><a href="#cb4-47"></a>        p<span class="op">.</span>increment<span class="op">();</span> </span>
<span id="cb4-48"><a href="#cb4-48"></a>    <span class="op">}</span></span>
<span id="cb4-49"><a href="#cb4-49"></a>    <span class="cf">return</span> sum <span class="op">+</span> nb<span class="op">;</span></span>
<span id="cb4-50"><a href="#cb4-50"></a><span class="op">}</span></span>
<span id="cb4-51"><a href="#cb4-51"></a></span>
<span id="cb4-52"><a href="#cb4-52"></a>long_computation_minimal<span class="op">(</span><span class="dv">10</span><span class="op">)</span></span></code></pre></div>
<p>The <code>display()</code> method in this example does nothing more than printing the word
<code>Progress</code>. <code>update()</code> concatenates a <code>+</code> symbol every time <code>Progress::increment()</code> is
called. The result looks like this:</p>
<pre><code>Progress: ++++++++++</code></pre>
<p>In comparison to the example of the default progress bar above, I moved the
call to <code>increment()</code> out of the second level and into the first level loop to keep
the amount of console output at bay. <code>update()</code> also checks if the display is <code>_finalized</code>.
<code>end_display</code> triggers the finalization.</p>
<h3 id="remaining-time-estimation">Remaining time estimation</h3>
<p>Based on the minimal setup above, you can implement more sophisticated
progress bars. Here’s an example of one that looks exactly like the default
<code>SimpleProgressBar</code>, but adds an estimation of the remaining time for the process to finish.
You can find a complete package setup with the code for this ETAProgressBar
<a href="https://github.com/kforner/rcpp_progress/tree/master/inst/examples/RcppProgressETA">here</a>.
In this article we only highlight some crucial aspects of the implementation.</p>
<p>We use the <a href="https://stat.ethz.ch/R-manual/R-devel/RHOME/doc/manual/R-exts.html#Setting-R-callbacks">Rinterface.h</a> header to update the display dynamically. Unfortunately this <a href="https://stackoverflow.com/questions/47623478/creating-a-progress-update-by-replacing-output-in-the-r-console-from-c-c/47624175?noredirect=1#comment82228757_47624175">header is only available for Unix-like systems</a>.
A less cool, old version of an ETA progress bar that also works on windows can be
found <a href="https://github.com/kforner/rcpp_progress/blob/5b0ec0d672c7758cf4c4134e97dfa9921ac668e0/inst/examples/RcppProgressETA/src/eta_progress_bar.hpp">here</a>.
The following preprocessor statements load Rinterface.h if the code is compiled
on a non-windows computer.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1"></a><span class="pp">#if !defined(WIN32) &amp;&amp; !defined(__WIN32) &amp;&amp; !defined(__WIN32__)</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="pp">#include </span><span class="im">&lt;Rinterface.h&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="pp">#endif</span></span></code></pre></div>
<p>The class <code>ETAProgressBar</code> inherits from the abstract class <code>ProgressBar</code>.
It has an integer variable <code>_max_ticks</code> that controls the amount of individual
tick symbols necessary to reach the 100% mark of the progress bar. That depends
on the display you want to craft. <code>ETAProgressBar</code> also has a boolean flag variable
<code>_timer_flag</code> that acts as a switch to separate the initial starting turn where
the time measurement starts and the following turns where the time is picked off.
The measured time values are stored in two variables <code>start</code> and <code>end</code> of class
<code>time_t</code> (from <a href="http://www.cplusplus.com/reference/ctime/">ctime</a>).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">class</span> ETAProgressBar<span class="op">:</span> <span class="kw">public</span> ProgressBar<span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="co">// ...</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  </span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="kw">private</span><span class="op">:</span> </span>
<span id="cb7-6"><a href="#cb7-6"></a>    <span class="dt">int</span> _max_ticks<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="dt">bool</span> _finalized<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="dt">bool</span> _timer_flag<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="dt">time_t</span> start<span class="op">,</span>end<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>    </span>
<span id="cb7-11"><a href="#cb7-11"></a>  <span class="co">// ...  </span></span>
<span id="cb7-12"><a href="#cb7-12"></a>    </span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>display()</code> function initializes the progress bar visualization. The first two lines
are hard coded ASCII art.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1"></a><span class="dt">void</span> display<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  REprintf<span class="op">(</span><span class="st">&quot;0</span><span class="sc">%%</span><span class="st">   10   20   30   40   50   60   70   80   90   100</span><span class="sc">%%\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>  REprintf<span class="op">(</span><span class="st">&quot;[----|----|----|----|----|----|----|----|----|----|</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  flush_console<span class="op">();</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="op">}</span></span></code></pre></div>
<p><code>update()</code> is the most important function for the progress bar mechanism. The if clause
allows to separate the initial call of <code>update()</code> from the following ones to start the time
counter. Afterwards the time passed is calculated and transformed to a human readable string
by the custom function <code>_time_to_string()</code>. <code>_current_ticks_display()</code> is another custom
function to transform the progress information to a string with the correct amount of <code>*</code>
symbols and filling whitespaces. The progress string and the time string are concatenated
to create the additional third line below the initial two lines drawn by <code>display()</code>.
A string with sufficient whitespaces is also added to ensure that this dynamically updated
line is overwritten completely from turn to turn. <code>REprintf("\r");</code> triggers a carriage return
to make this continuous overwriting possible.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1"></a><span class="dt">void</span> update<span class="op">(</span><span class="dt">float</span> progress<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  </span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="co">// stop if already finalized</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="cf">if</span> <span class="op">(</span>_finalized<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>  </span>
<span id="cb9-6"><a href="#cb9-6"></a>    <span class="co">// start time measurement when update() is called the first time</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="cf">if</span> <span class="op">(</span>_timer_flag<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>        _timer_flag <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>        <span class="co">// measure start time</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>        time<span class="op">(&amp;</span>start<span class="op">);</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>    </span>
<span id="cb9-13"><a href="#cb9-13"></a>        <span class="co">// measure current time</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>        time<span class="op">(&amp;</span>end<span class="op">);</span></span>
<span id="cb9-15"><a href="#cb9-15"></a>    </span>
<span id="cb9-16"><a href="#cb9-16"></a>        <span class="co">// calculate passed time and remaining time (in seconds)</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>        <span class="dt">double</span> pas_time <span class="op">=</span> <span class="bu">std::</span>difftime<span class="op">(</span>end<span class="op">,</span> start<span class="op">);</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>        <span class="dt">double</span> rem_time <span class="op">=</span> <span class="op">(</span>pas_time <span class="op">/</span> progress<span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="dv">1</span> <span class="op">-</span> progress<span class="op">);</span></span>
<span id="cb9-19"><a href="#cb9-19"></a>    </span>
<span id="cb9-20"><a href="#cb9-20"></a>        <span class="co">// convert seconds to time string</span></span>
<span id="cb9-21"><a href="#cb9-21"></a>        <span class="bu">std::</span>string time_string <span class="op">=</span> _time_to_string<span class="op">(</span>rem_time<span class="op">);</span></span>
<span id="cb9-22"><a href="#cb9-22"></a>    </span>
<span id="cb9-23"><a href="#cb9-23"></a>        <span class="co">// create progress bar string </span></span>
<span id="cb9-24"><a href="#cb9-24"></a>        <span class="bu">std::</span>string progress_bar_string <span class="op">=</span> _current_ticks_display<span class="op">(</span>progress<span class="op">);</span></span>
<span id="cb9-25"><a href="#cb9-25"></a>    </span>
<span id="cb9-26"><a href="#cb9-26"></a>        <span class="co">// ensure overwriting of old time info</span></span>
<span id="cb9-27"><a href="#cb9-27"></a>        <span class="dt">int</span> empty_length <span class="op">=</span> time_string<span class="op">.</span>length<span class="op">();</span></span>
<span id="cb9-28"><a href="#cb9-28"></a>        <span class="bu">std::</span>string empty_space <span class="op">=</span> <span class="bu">std::</span>string<span class="op">(</span>empty_length<span class="op">,</span> <span class="ch">' '</span><span class="op">);</span></span>
<span id="cb9-29"><a href="#cb9-29"></a>    </span>
<span id="cb9-30"><a href="#cb9-30"></a>        <span class="co">// merge progress bar and time string</span></span>
<span id="cb9-31"><a href="#cb9-31"></a>        <span class="bu">std::</span>stringstream strs<span class="op">;</span></span>
<span id="cb9-32"><a href="#cb9-32"></a>        strs <span class="op">&lt;&lt;</span> <span class="st">&quot;|&quot;</span> <span class="op">&lt;&lt;</span> progress_bar_string <span class="op">&lt;&lt;</span> <span class="st">&quot;| &quot;</span> <span class="op">&lt;&lt;</span> time_string <span class="op">&lt;&lt;</span> empty_space<span class="op">;</span></span>
<span id="cb9-33"><a href="#cb9-33"></a>        <span class="bu">std::</span>string temp_str <span class="op">=</span> strs<span class="op">.</span>str<span class="op">();</span></span>
<span id="cb9-34"><a href="#cb9-34"></a>        <span class="dt">char</span> <span class="at">const</span><span class="op">*</span> <span class="dt">char_type</span> <span class="op">=</span> temp_str<span class="op">.</span>c_str<span class="op">();</span></span>
<span id="cb9-35"><a href="#cb9-35"></a>    </span>
<span id="cb9-36"><a href="#cb9-36"></a>        <span class="co">// print: remove old display and replace with new</span></span>
<span id="cb9-37"><a href="#cb9-37"></a>        REprintf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb9-38"><a href="#cb9-38"></a>        REprintf<span class="op">(</span><span class="st">&quot;</span><span class="sc">%s</span><span class="st">&quot;</span><span class="op">,</span> <span class="dt">char_type</span><span class="op">);</span></span>
<span id="cb9-39"><a href="#cb9-39"></a>    </span>
<span id="cb9-40"><a href="#cb9-40"></a>        <span class="co">// finalize display when ready</span></span>
<span id="cb9-41"><a href="#cb9-41"></a>        <span class="cf">if</span><span class="op">(</span>progress <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-42"><a href="#cb9-42"></a>           _finalize_display<span class="op">();</span></span>
<span id="cb9-43"><a href="#cb9-43"></a>        <span class="op">}</span>  </span>
<span id="cb9-44"><a href="#cb9-44"></a>    <span class="op">}</span></span>
<span id="cb9-45"><a href="#cb9-45"></a><span class="op">}</span></span></code></pre></div>
<p><code>_time_to_string()</code> parses time information given in form of a floating point number of
seconds to a human-readable string. The basic algorithm is based on an example from
<a href="http://www.programmingnotes.org/?p=2062">programmingnotes.org</a>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1"></a><span class="bu">std::</span>string _time_to_string<span class="op">(</span><span class="dt">double</span> seconds<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  </span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="dt">int</span> time <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span> seconds<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  </span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="dt">int</span> hour <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>    <span class="dt">int</span> min <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>    <span class="dt">int</span> sec <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>  </span>
<span id="cb10-9"><a href="#cb10-9"></a>    hour <span class="op">=</span> time <span class="op">/</span> <span class="dv">3600</span><span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>    time <span class="op">=</span> time <span class="op">%</span> <span class="dv">3600</span><span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>    min <span class="op">=</span> time <span class="op">/</span> <span class="dv">60</span><span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>    time <span class="op">=</span> time <span class="op">%</span> <span class="dv">60</span><span class="op">;</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>    sec <span class="op">=</span> time<span class="op">;</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>  </span>
<span id="cb10-15"><a href="#cb10-15"></a>    <span class="bu">std::</span>stringstream time_strs<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16"></a>    <span class="cf">if</span> <span class="op">(</span>hour <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> time_strs <span class="op">&lt;&lt;</span> hour <span class="op">&lt;&lt;</span> <span class="st">&quot;h &quot;</span><span class="op">;</span></span>
<span id="cb10-17"><a href="#cb10-17"></a>    <span class="cf">if</span> <span class="op">(</span>min <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> time_strs <span class="op">&lt;&lt;</span> min <span class="op">&lt;&lt;</span> <span class="st">&quot;min &quot;</span><span class="op">;</span></span>
<span id="cb10-18"><a href="#cb10-18"></a>    <span class="cf">if</span> <span class="op">(</span>sec <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> time_strs <span class="op">&lt;&lt;</span> sec <span class="op">&lt;&lt;</span> <span class="st">&quot;s &quot;</span><span class="op">;</span></span>
<span id="cb10-19"><a href="#cb10-19"></a>    <span class="bu">std::</span>string time_str <span class="op">=</span> time_strs<span class="op">.</span>str<span class="op">();</span></span>
<span id="cb10-20"><a href="#cb10-20"></a>  </span>
<span id="cb10-21"><a href="#cb10-21"></a>    <span class="cf">return</span> time_str<span class="op">;</span></span>
<span id="cb10-22"><a href="#cb10-22"></a><span class="op">}</span></span></code></pre></div>
<p><code>_current_ticks_display()</code> relies on <code>_compute_nb_ticks()</code> to first of all transform
the progress information (floating point number between 0 and 1) to a natural number
that expresses the correct fraction of <code>_max_ticks</code>. <code>_construct_ticks_display_string()</code>
takes this value and parses a string with <code>*</code> symbols and whitespaces that can be plotted
as a visual progress indication.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1"></a><span class="bu">std::</span>string _current_ticks_display<span class="op">(</span><span class="dt">float</span> progress<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>    <span class="dt">int</span> nb_ticks <span class="op">=</span> _compute_nb_ticks<span class="op">(</span>progress<span class="op">);</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>    <span class="bu">std::</span>string cur_display <span class="op">=</span> _construct_ticks_display_string<span class="op">(</span>nb_ticks<span class="op">);</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>    <span class="cf">return</span> cur_display<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="op">}</span></span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="dt">int</span> _compute_nb_ticks<span class="op">(</span><span class="dt">float</span> progress<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>    <span class="cf">return</span> <span class="dt">int</span><span class="op">(</span>progress <span class="op">*</span> _max_ticks<span class="op">);</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="op">}</span></span>
<span id="cb11-10"><a href="#cb11-10"></a></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="bu">std::</span>string _construct_ticks_display_string<span class="op">(</span><span class="dt">int</span> nb<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>    <span class="bu">std::</span>stringstream ticks_strs<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="op">(</span>_max_ticks <span class="op">-</span> <span class="dv">1</span><span class="op">);</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> nb<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>            ticks_strs <span class="op">&lt;&lt;</span> <span class="st">&quot;*&quot;</span><span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>            ticks_strs <span class="op">&lt;&lt;</span> <span class="st">&quot; &quot;</span><span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>        <span class="op">}</span></span>
<span id="cb11-19"><a href="#cb11-19"></a>    <span class="op">}</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>    <span class="bu">std::</span>string tick_space_string <span class="op">=</span> ticks_strs<span class="op">.</span>str<span class="op">();</span></span>
<span id="cb11-21"><a href="#cb11-21"></a>    <span class="cf">return</span> tick_space_string<span class="op">;</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="op">}</span></span></code></pre></div>
<p><code>flush_console()</code> is a wrapper around <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Setting-R-callbacks"><code>R_FlushConsole()</code></a> which is called to flush any
pending output to the system console. It’s necessary to do this when the display is started
in <code>display()</code> and when it’s closed in <code>_finalize_display()</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1"></a><span class="dt">void</span> flush_console<span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="pp">#if !defined(WIN32) &amp;&amp; !defined(__WIN32) &amp;&amp; !defined(__WIN32__)</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>          R_FlushConsole<span class="op">();</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="pp">#endif</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="op">}</span></span></code></pre></div>
<p>The output of an <code>ETAProgressBar</code> looks like this:</p>
<pre><code>0%   10   20   30   40   50   60   70   80   90   100%
[----|----|----|----|----|----|----|----|----|----|
|*******                                          | 49s</code></pre>
    </section>
</article>

        </main>

        <footer>
            Site generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
